# План релизов Orpheus

## Версия 1.1.1 (Patch Release) - Критические исправления и стабильность
**Цель:** Исправить критические баги и проблемы, обнаруженные первыми пользователями  
**Срок:** 1-2 недели  
**Тип:** Patch (баги, исправления, стабильность)

### Критические баги (MUST HAVE)

#### UI/UX проблемы
1. **Шрифты на Samsung S25 Ultra** - текст выходит за рамки в диалоге
   - Файл: `lib/chat_screen.dart:590-597`
   - Решение: Добавить `overflow: TextOverflow.visible`, `softWrap: true`, протестировать на реальном устройстве

2. **Изменить сообщение "Поделиться кодом"** - текст обрезается при парсинге
   - Файл: `lib/screens/settings_screen.dart:795`
   - Решение: Изменить формат на "Мой ключ: [ключ]" или добавить парсинг только части после ":"

3. **Не закрывается приложение при автоматической блокировке телефона**
   - Файл: `lib/main.dart:281-303`
   - Решение: Улучшить обработку `AppLifecycleState.paused`, проверить настройки Android

#### Технический долг и стабильность
4. **Очистка дубликатов зависимостей в requirements.txt**
   - Файл: `D:\Programs\orpheus\requirements.txt`
   - Проблема: httpcore, httptools, httpx повторяются 3 раза
   - Решение: Удалить дубликаты, оставить одну версию каждой зависимости

5. **Добавить валидацию размера сообщений (DoS защита)**
   - Файл: `D:\Programs\orpheus\main.py:919-996`
   - Решение: Добавить проверку `len(data) > MAX_MESSAGE_SIZE` (например, 1MB), отклонять большие сообщения

6. **Улучшить обработку ошибок при шифровании/дешифровании**
   - Файл: `lib/services/crypto_service.dart`, `lib/services/incoming_message_handler.dart`
   - Решение: Добавить try-catch с понятными сообщениями об ошибках, логирование

7. **Добавить exponential backoff для WebSocket реконнекта**
   - Файл: `lib/services/websocket_service.dart:141-145`
   - Решение: Вместо фиксированных 3 секунд использовать exponential backoff (3s, 6s, 12s, 24s, max 60s)

8. **Добавить индикацию загрузки при отправке сообщения**
   - Файл: `lib/chat_screen.dart:123-153`
   - Решение: Показывать индикатор загрузки до получения подтверждения отправки

9. **Обработка ошибок при потере соединения во время отправки**
   - Файл: `lib/services/websocket_service.dart:286-304`
   - Решение: Сохранять сообщения в очередь при потере соединения, отправлять при восстановлении

10. **Добавить индексы в БД для производительности**
    - Файл: `lib/services/database_service.dart:97-109`
    - Решение: Добавить индексы на `contactPublicKey`, `timestamp`, `isRead` в таблице `messages`

11. **Валидация публичных ключей на клиенте**
    - Файл: `lib/services/crypto_service.dart`
    - Решение: Проверять формат и длину публичного ключа перед использованием

12. **Улучшить логирование ошибок (убрать print, использовать DebugLogger)**
    - Файлы: `lib/services/websocket_service.dart`, `lib/services/update_service.dart`
    - Решение: Заменить все `print()` на `DebugLogger` для консистентности

### Улучшения производительности
13. **Оптимизация запросов к БД (batch operations)**
    - Файл: `lib/services/database_service.dart`
    - Решение: Использовать транзакции для множественных операций

14. **Добавить кэширование контактов в памяти**
    - Файл: `lib/services/database_service.dart:120-133`
    - Решение: Кэшировать список контактов, обновлять при изменениях

---

## Версия 1.2.0 (Minor Release) - Новые функции и улучшения
**Цель:** Добавить важные функции и улучшить пользовательский опыт  
**Срок:** 3-4 недели  
**Тип:** Minor (новые функции, улучшения UX)

### Новые функции (SHOULD HAVE)

#### UX улучшения
1. **Время и дата в диалоге**
   - Группировка сообщений по датам
   - Отображение даты при смене дня
   - Оптимизация отображения времени (скрывать, если совпадает с предыдущим)
   - Файл: `lib/chat_screen.dart:499-668`

2. **Ограничение лицензии по времени**
   - Добавить поле `expires_at` в таблицу `licenses`
   - Обновить `check_license()` для проверки срока
   - Добавить тестовые лицензии в админке
   - Файлы: `D:\Programs\orpheus\payments.py:37-45`, `D:\Programs\orpheus\main.py:382-388`

3. **Организация воронки обратной связи**
   - Форма обратной связи в приложении
   - Форма на сайте
   - Интеграция с админкой для просмотра отзывов
   - Новые файлы: `lib/screens/feedback_screen.dart`, `D:\Programs\OPHEUS_ADMIN\app\routers\feedback.py`

4. **Вывод TURN входа из клиента**
   - Вынести TURN настройки в конфиг сервера
   - Передавать через WebSocket при подключении
   - Файлы: `lib/screens/status_screen.dart:38`, `D:\Programs\orpheus\main.py`

### Безопасность и инфраструктура
5. **Вывести БД в приватную сеть Postgres + Redis**
   - Настройка VPN/приватной сети
   - Обновление `DATABASE_URL` и `REDIS_URL`
   - Документация по настройке
   - Файлы: `.env.example`, `docs/DEPLOYMENT.md`

6. **Анализ Паттернов подбора и перегрузки на сервере**
   - Rate limiting для WebSocket подключений
   - Мониторинг подозрительной активности
   - Логирование попыток подбора ключей
   - Файл: `D:\Programs\orpheus\main.py:904-1000`

7. **Прокси сервер при подключении сокета или VPN**
   - Поддержка прокси в WebSocket клиенте
   - Настройка через конфиг
   - Файл: `lib/services/websocket_service.dart`

### Технические улучшения
8. **Мониторинг и метрики**
   - Добавить метрики использования (количество сообщений, контактов)
   - Health check endpoint
   - Файл: `D:\Programs\orpheus\main.py`

9. **Улучшение обработки офлайн сообщений**
   - Приоритизация важных сообщений
   - Уведомления о доставке
   - Файл: `D:\Programs\orpheus\main.py:586-614`

10. **Оптимизация использования памяти**
    - Очистка старых сообщений из памяти
    - Лимит на количество загружаемых сообщений в чате
    - Файл: `lib/chat_screen.dart:87-103`

---

## Дополнительные задачи (обнаружены при анализе кода)

### Критичные для стабильности
- **Добавить проверку версии протокола** - для совместимости при обновлениях
- **Обработка случая когда сервер перезагружается во время активного соединения** - graceful reconnection
- **Добавить таймауты для всех сетевых операций** - избежать зависаний
- **Валидация JSON перед парсингом** - защита от некорректных данных

### Улучшения UX
- **Добавить pull-to-refresh в список контактов** - обновление статусов
- **Улучшить анимации при отправке сообщений** - более плавные переходы
- **Добавить звуковые уведомления для важных сообщений** - настройки в профиле
- **Темная тема (уже есть, но можно улучшить)** - проверить контрастность

### Безопасность
- **Добавить проверку целостности сообщений** - защита от модификации
- **Регулярная ротация ключей (опционально)** - для повышенной безопасности
- **Аудит действий пользователя** - логирование важных операций

### Производительность
- **Ленивая загрузка сообщений** - загружать по частям при скролле
- **Оптимизация изображений** - если будут добавлены в будущем
- **Кэширование криптографических операций** - для часто используемых ключей

---

## Рекомендации по версионированию

### SemVer правила:
- **1.1.1 (Patch)**: Только баги и критические исправления
- **1.2.0 (Minor)**: Новые функции, обратно совместимые изменения
- **2.0.0 (Major)**: Breaking changes (например, изменение протокола)

### Критерии готовности к релизу:

**Для 1.1.1:**
- ✅ Все критические баги исправлены
- ✅ Тесты проходят
- ✅ Нет регрессий
- ✅ Обновлен CHANGELOG.md

**Для 1.2.0:**
- ✅ Все функции из плана реализованы
- ✅ Тесты покрывают новые функции
- ✅ Документация обновлена
- ✅ Обратная совместимость сохранена
- ✅ Обновлен CHANGELOG.md

---

## Приоритизация задач

### P0 (Критично - блокирует релиз)
1. Шрифты на Samsung S25 Ultra
2. Валидация размера сообщений (DoS защита)
3. Обработка ошибок при шифровании/дешифровании

### P1 (Важно - должно быть в 1.1.1)
4. Изменить сообщение "Поделиться кодом"
5. Не закрывается приложение при блокировке
6. Exponential backoff для реконнекта
7. Индексы в БД

### P2 (Желательно - можно в 1.2.0)
8. Время и дата в диалоге
9. Ограничение лицензии по времени
10. Вывести БД в приватную сеть

### P3 (Nice to have - будущие версии)
11. Локализация
12. Два устройства с одним ключом
13. Перенос аккаунта





