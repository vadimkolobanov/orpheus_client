# ADR 0003: Система безопасности входа (PIN, Duress, Panic Wipe)

## Статус
Принято

## Контекст
Приложение Orpheus — защищённый мессенджер с E2E шифрованием. Однако приложение открывалось без какой-либо защиты входа, что создавало риск при физическом доступе к устройству.

Требования:
1. Опциональная защита PIN-кодом (по умолчанию — вход открыт)
2. "Код принуждения" (duress code) — второй PIN, показывающий пустой профиль
3. Экстренное удаление данных при тройном нажатии кнопки питания
4. Сохранение полной анонимности (без привязки к email/телефону)

## Решение

### 1. Модель безопасности (`SecurityConfig`)
- 6-значный PIN-код с хешированием SHA-256 + соль (10000 итераций)
- Отдельный duress-код с собственной солью
- Отдельный **код удаления (wipe code)** с собственной солью
- Прогрессивная блокировка: 5 попыток → 30 сек, 10 → 1 мин, 15 → 5 мин, 20 → 30 мин
- Опциональный auto-wipe после N неудачных попыток

### 2. Сервис авторизации (`AuthService`)
- Singleton с хранением конфигурации в `FlutterSecureStorage`
- Проверка PIN возвращает enum: `success | duress | invalid | lockedOut | autoWipe`
- Флаг `isDuressMode` для переключения режима отображения данных
- Проверка PIN также поддерживает `wipeCode` (код удаления), который **требует подтверждения удержанием** в UI

### 3. Duress Mode (режим принуждения)
- При вводе duress-кода приложение разблокируется, но `isDuressMode = true`
- `DatabaseService` проверяет флаг и возвращает пустые данные:
  - `getContacts()` → `[]`
  - `getMessagesForContact()` → `[]`
  - `getProfileStats()` → `{contacts: 0, messages: 0, sent: 0}`
- Реальные данные остаются на месте, но скрыты

### 4. Panic Wipe
- `PanicWipeService` отслеживает переходы в `AppLifecycleState.paused`
- Важное ограничение: без нативного кода Flutter не перехватывает физические нажатия кнопки питания.
  Текущая реализация — приближение: **3 быстрых ухода приложения в background** (обычно серия блокировок/разблокировок
  экрана или быстрое сворачивание приложения).
- По умолчанию жест **выключен**, чтобы избежать случайного удаления данных
- Выполняется полный wipe: ключи, БД, конфигурация безопасности

### 5. Блокировка при сворачивании
- При переходе в background приложение блокируется (если PIN включен)
- При возврате требуется ввод PIN или биометрия

## Последствия

### Положительные
- Защита от физического доступа к устройству
- Plausible deniability через duress-код
- Экстренное удаление при угрозе
- Анонимность сохранена (нет привязки к внешним идентификаторам)

### Отрицательные
- Пользователь может забыть PIN (восстановление только через приватный ключ)
- Тройное нажатие может случайно сработать (маловероятно)
- Duress mode не скрывает факт наличия приложения

### Риски
- При потере приватного ключа и забытом PIN — данные утеряны навсегда
- Атакующий может заставить ввести оба кода

## Альтернативы рассмотренные

1. **Пароль вместо PIN** — отвергнуто, т.к. менее удобно на мобильных устройствах
2. **Только биометрия** — отвергнуто, т.к. не везде доступна и может быть обойдена
3. **Удаление данных в duress** — отвергнуто, т.к. пустой профиль менее подозрителен
4. **Shake-to-wipe** — может быть добавлено позже как дополнительный механизм

## Файлы

- `lib/models/security_config.dart` — модель конфигурации
- `lib/services/auth_service.dart` — логика авторизации
- `lib/services/panic_wipe_service.dart` — отслеживание тройного нажатия
- `lib/screens/lock_screen.dart` — экран блокировки
- `lib/screens/pin_setup_screen.dart` — настройка PIN
- `lib/screens/security_settings_screen.dart` — настройки безопасности

