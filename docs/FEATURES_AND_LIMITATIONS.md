# Orpheus Client — особенности, плюсы, недоработки

## Особенности (то, что отличает реализацию)
- **Идентичность по ключу**: нет телефона/email; public key — “ID”.
- **E2E шифрование сообщений**: шифрование/дешифрование на клиенте (`CryptoService`).
- **Устойчивость сети**:
  - WS реконнект с backoff;
  - обработка смены сети;
  - fallback по доменам (primary → legacy);
  - очередь исходящих сообщений при оффлайне (`PendingActionsService`).
- **Звонки “в реальности”**:
  - буфер ICE до offer;
  - ICE restart при деградации сети;
  - foreground service на время звонка (Android).
- **Privacy‑ориентированные уведомления**: push не показывает текст сообщения.
- **Duress режим**: UI скрывает реальные данные (пустой профиль).
- **Oracle of Orpheus**: встроенный AI-ассистент с памятью (до 20 сообщений), Markdown‑рендеринг, suggestion-кнопки, сохранение ответов в Notes Vault.
- **Notes Vault**: зашифрованные заметки с tracking источника (ручной ввод, контакт, комната, Oracle); duress mode скрывает.
- **Rooms (групповые чаты)**: создание/присоединение по invite-коду, panic clear (безвозвратное удаление), серверные настройки уведомлений per-room.
- **Desktop Link**: QR‑сопряжение мобильного с десктопом через LAN WebSocket (в разработке).
- **Автоблокировка по неактивности**: блокировка после периода неактивности (если PIN установлен); не блокирует во время звонка.
- **Очистка сообщений по политике**: автоудаление старых сообщений по retention policy.
- **In-app обновления**: скачивание APK с прогрессом и валидацией; установка через системный установщик.

## Плюсы (сильные стороны)
- **Ясное разделение на сервисы**: сеть/крипто/БД/уведомления/безопасность — отдельные модули.
- **Контрактная обработка входящих сообщений**: `IncomingMessageHandler` как единая точка, удобная для тестирования.
- **Best‑effort подход в критичных местах**: фоновые сервисы/уведомления/реконнект не должны “ронять” приложение.
- **Подготовка к миграции инфраструктуры**: механизмы доменного fallback встроены в клиент.

## Недоработки (технический долг и риски)
Сводка ориентирована на то, что влияет на качество и безопасность.

### 1) Безопасность хранения данных на устройстве (высокий приоритет)
- Локальная БД хранит **расшифрованные** сообщения (`DatabaseService`).
- Wipe‑процедура в текущем виде требует отдельной проверки на “физическое” удаление данных с диска (см. `docs/SECURITY_REVIEW.md`).

### 2) Конфигурация WebRTC/TURN (высокий приоритет)
- TURN endpoint и credentials заданы в коде (`webrtc_service.dart`).
  Это риск утечки инфраструктуры и абьюза.

### 3) Аутентификация/авторизация на API (высокий приоритет, системный)
- Некоторые HTTP эндпоинты используют `pubkey` как параметр/заголовок (например support/promo).
  Без серверной привязки к сессии/подписи это может быть слабым местом системы.

### 4) Тестовые пробелы (качество/регрессии)
- Есть области, где важные сценарии закреплены не полностью (UI чата/звонка, интеграции уведомлений и т.п.).
- Новые фичи (Oracle AI, Rooms, Notes Vault, Desktop Link) пока не покрыты тестами.

### 5) Наблюдаемость и приватность логов
- В режиме разработки включена **полная телеметрия** (клиент/сервер).
- Риск приватности высокий: логируются технические контексты и payload.
- Нужна политика и флаг отключения телеметрии для прод‑режима.



