# Orpheus Client — обзор безопасности (проблемы и рекомендации)

## Цель документа
Зафиксировать **реальные риски** и “границы обещаний” безопасности клиента, чтобы:
- понимать, от каких угроз защищаемся, а от каких — нет;
- приоритизировать исправления;
- не строить процессы/маркетинг на предположениях.

## Что уже сделано (клиент)
- **E2E для сообщений**: шифрование на клиенте (X25519 + ChaCha20‑Poly1305).
- **Secure storage для ключей**: ключи и security config хранятся в `flutter_secure_storage`.
- **Privacy в уведомлениях**: текст сообщения не показывается в уведомлении.
- **Защита UI при физическом доступе**: PIN + lockout ladder + duress mode + wipe code (см. ADR).

## Критичные проблемы безопасности (P0/P1)

### P0 — TURN credentials и endpoint захардкожены в клиенте
**Где**: `lib/services/webrtc_service.dart` (`rtcConfiguration`).

**Почему это опасно**:
- утечка инфраструктуры и статических кредов (их нельзя “считать секретом”);
- риск абьюза TURN (затраты/DoS);
- невозможность нормальной ротации/разделения сред.

**Рекомендация**:
- вынести TURN параметры на сервер (выдача краткоживущих credentials, например TURN REST API);
- убрать креды из репозитория; обеспечить ротацию.

### P0 — Wipe может быть неполным (физическое удаление данных)
**Где**: `lib/services/auth_service.dart` (`performWipe()`), `lib/services/database_service.dart`.

**Наблюдение по коду**:
- wipe закрывает БД через `DatabaseService.instance.close()`, но **не удаляет файл БД** явно.
- `DatabaseService` хранит сообщения **в расшифрованном виде** в SQLite.

**Риск**:
- после “wipe” на устройстве могут остаться recoverable данные (контакты/сообщения) в файле БД/кэше.

**Рекомендация**:
- сделать wipe “жёстким”: удаление файла БД через `deleteDatabase(...)`/удаление директории данных (аккуратно);
- добавить тест/проверку, что после wipe и повторной инициализации данные отсутствуют.

### P0 — Слабая/неочевидная аутентификация некоторых HTTP API (системный риск)
**Где**:
- `lib/services/support_chat_service.dart` использует заголовок `X-Pubkey`.
- `lib/license_screen.dart` отправляет `pubkey` в body для `/api/activate-promo`.
- `lib/services/websocket_service.dart` отправляет HTTP fallback для `/api/signal` с `sender_pubkey` в body.

**Почему это опасно**:
Если сервер доверяет “pubkey из заголовка/body” без доказательства владения ключом/сессией, возможны:
- подмена отправителя сигналов/активаций;
- спам/абьюз.

**Рекомендация** (для всей системы, не только клиента):
- сервер должен авторизовать запросы через связанный контекст (например: токен, подпись, привязка к WS‑сессии);
- для критичных сигналов использовать подпись (Ed25519) или иной проверяемый механизм, если модель угроз требует.

## Важные риски (P2)

### P2 — PIN hashing не memory‑hard
**Где**: `lib/services/auth_service.dart` (`_hashPin`, 10k SHA‑256 iterations).

**Риск**:
Если атакующий получает доступ к security config (salt+hash), перебор 6‑значного PIN может быть относительно дешёвым на GPU/ASIC.

**Рекомендация**:
- рассмотреть Argon2id/scrypt/PBKDF2‑HMAC‑SHA256 с адекватными параметрами (с учётом мобильного CPU);
- или явно формулировать: PIN — защита от “случайного доступа”, не от целевого forensic‑атакующего.

### P2 — Логи могут содержать чувствительные данные
**Где**: `DebugLogger` + места, где логируются токены/диагностика.

**Риск**:
Экспорт логов в поддержку может раскрыть токены/метаданные.

**Рекомендация**:
- ввести политику redaction (маскирование токенов/идентификаторов);
- документировать, что допустимо попадать в логи.

## Duress mode: что он гарантирует и что нет
**Гарантирует**:
- в UI показывается “пустой профиль” (контакты/сообщения/статистика — пусто).

**Не гарантирует**:
- физическое отсутствие данных на диске;
- защиту при компрометации устройства.

## Рекомендуемый порядок исправлений (roadmap по безопасности)
- **P0**: убрать TURN креды из клиента, сделать выдачу краткоживущих credentials.
- **P0**: сделать wipe физически удаляющим локальные данные.
- **P0/P1**: пересмотреть модель авторизации HTTP endpoints (support/promo/signal).
- **P2**: улучшить PIN hashing или явно ограничить обещания модели угроз.
- **P2**: redaction для логов.


